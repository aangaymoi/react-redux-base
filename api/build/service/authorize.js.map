{"version":3,"sources":["../../source/service/authorize.ts"],"names":["log","None","Admin","token","user","userRepo","search","exact","type","obj","refresh","_id","uuid","Logged"],"mappings":"2dACA,KAAMA,CAAAA,GAAG,CAAG,mBAAM,uBAAN,CAAZ,CAcO,KAAMC,CAAAA,IAAsB,4CACX,SACb,mBAFwB,G,kBAM5B,KAAMC,CAAAA,KAAuB,4CACZ,KAAOC,CAAAA,CAAP,EAAuD,CAC3E,KAAMC,CAAAA,CAAI,CAAG,KAAMC,eAASC,MAAT,CACjB,MADiB,CAEjBH,CAFiB,CAGjB,CAAEI,KAAK,GAAP,CAHiB,CAIhB,4EAJgB,CAAnB,CAMA,GAAIH,CAAI,EAA4B,OAAxB,GAACA,CAAD,CAAeI,IAA3B,CAA6C,CAC3C,KAAMC,CAAAA,CAAG,CAAG,KAAMJ,eAASK,OAAT,CAAkBN,CAAD,CAAeO,GAAhC,CAAlB,CACA,MAAQF,CAAAA,CAAD,CAAcG,IACtB,CAEF,CAbiC,G,oBAgB7B,KAAMC,CAAAA,MAAwB,4CACb,KAAOV,CAAAA,CAAP,EAAuD,CAC3E,KAAMC,CAAAA,CAAI,CAAG,KAAMC,eAASC,MAAT,CACjB,MADiB,CAEjBH,CAFiB,CAGjB,CAAEI,KAAK,GAAP,CAHiB,CAIhB,4EAJgB,CAAnB,CAMA,GAAIH,CAAI,EAA4B,MAAxB,GAACA,CAAD,CAAeI,IAA3B,CAA4C,CAC1C,KAAMC,CAAAA,CAAG,CAAG,KAAMJ,eAASK,OAAT,CAAkBN,CAAD,CAAeO,GAAhC,CAAlB,CACA,MAAQF,CAAAA,CAAD,CAAcG,IACtB,CAEF,CAbkC,G","sourcesContent":["import debug from 'debug'\r\nconst log = debug('api:service:authorize')\r\n\r\nimport uuid from 'uuid'\r\n\r\nimport userRepo, { User } from '../repo/user'\r\n\r\nexport type Check = {\r\n  (token?: string): Promise<string | undefined>\r\n}\r\n\r\nexport interface IAuth {\r\n  check: Check\r\n}\r\n\r\nexport class None implements IAuth {\r\n  public check: Check = async (token?: string): Promise<string | undefined> => {\r\n    return uuid()\r\n  }\r\n}\r\n\r\nexport class Admin implements IAuth {\r\n  public check: Check = async (token?: string): Promise<string | undefined> => {\r\n    const user = await userRepo.search(\r\n      'uuid',\r\n      token,\r\n      { exact: true },\r\n      `and ((current_timestamp - datetime(strftime(last_access))) / 3600000) < 2 `\r\n    )\r\n    if (user && (user as User).type === 'admin') {\r\n      const obj = await userRepo.refresh((user as User)._id as number)\r\n      return (obj as User).uuid\r\n    }\r\n    return undefined\r\n  }\r\n}\r\n\r\nexport class Logged implements IAuth {\r\n  public check: Check = async (token?: string): Promise<string | undefined> => {\r\n    const user = await userRepo.search(\r\n      'uuid',\r\n      token,\r\n      { exact: true },\r\n      `and ((current_timestamp - datetime(strftime(last_access))) / 3600000) < 2 `\r\n    )\r\n    if (user && (user as User).type === 'user') {\r\n      const obj = await userRepo.refresh((user as User)._id as number)\r\n      return (obj as User).uuid\r\n    }\r\n    return undefined\r\n  }\r\n}\r\n"],"file":"authorize.js"}