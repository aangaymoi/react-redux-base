{"version":3,"sources":["../../source/repo/user.ts"],"names":["log","UserRepo","constructor","database","object","Promise","resolve","self","run","type","name","email","password","error","all","lastID","rows","length","key","value","options","exact","order","limit","offset","extra","sql","changes","_id","userRepo"],"mappings":"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","sourcesContent":["import debug from 'debug'\r\nconst log = debug('api:repo:user')\r\n\r\nimport uuid from 'uuid'\r\n\r\nimport database from './database'\r\n\r\nexport interface Options {\r\n  exact?: boolean\r\n  order?: string\r\n  limit?: number\r\n  offset?: number\r\n}\r\n\r\nexport interface User {\r\n  _id?: number\r\n  type: string\r\n  uuid?: string\r\n  name: string\r\n  email: string\r\n  password?: string\r\n  created_at?: string\r\n  updated_at?: string\r\n  last_access?: string\r\n}\r\n\r\nexport class UserRepo {\r\n  public database: any\r\n  constructor(database: any) {\r\n    this.database = database\r\n  }\r\n\r\n  public create = async (object: User): Promise<User | undefined> => {\r\n    return new Promise(resolve => {\r\n      const self = this\r\n      this.database.run(\r\n        `insert into user (type, name, email, password) values (?, ?, ?, ?);`,\r\n        [object.type, object.name, object.email, object.password],\r\n        function(this: any, error: any) {\r\n          if (error) {\r\n            return resolve(undefined)\r\n          }\r\n          self.database.all(\r\n            `select _id, type, name, email, created_at, updated_at, last_access from user where _id = ?;`,\r\n            [this.lastID],\r\n            function(error: any, rows: [any]) {\r\n              if (error || !rows || !rows.length) {\r\n                return resolve(undefined)\r\n              }\r\n              return resolve(rows[0] as User)\r\n            }\r\n          )\r\n        }\r\n      )\r\n    })\r\n  }\r\n\r\n  public search = async (\r\n    key: string,\r\n    value: any,\r\n    options = {\r\n      exact: true,\r\n      order: 'desc',\r\n      limit: 10,\r\n      offset: 0,\r\n    } as Options,\r\n    extra?: string\r\n  ): Promise<[User] | User | undefined> => {\r\n    let sql = `select * from user where ${key} `\r\n    if (options) {\r\n      if (options.exact) {\r\n        sql = sql + `= ? `\r\n      } else {\r\n        sql = sql + `like ? `\r\n      }\r\n      if (extra) {\r\n        sql = sql + extra\r\n      }\r\n      if (options.order) {\r\n        sql = sql + `order by ${key} ${options.order} `\r\n      }\r\n      if (options.limit !== undefined && options.limit >= 0) {\r\n        sql = sql + `limit ${options.limit} `\r\n      }\r\n      if (options.offset !== undefined && options.offset >= 0) {\r\n        sql = sql + `offset ${options.offset} `\r\n      }\r\n    }\r\n    return new Promise(resolve => {\r\n      this.database.all(sql, [options.exact ? value : `%${value}%`], function(\r\n        error: any,\r\n        rows: [any]\r\n      ) {\r\n        if (error || !rows || !rows.length) {\r\n          return resolve(undefined)\r\n        }\r\n        if (options.exact) {\r\n          return resolve(rows[0] as User)\r\n        }\r\n        return resolve(rows as [User])\r\n      })\r\n    })\r\n  }\r\n\r\n  public listing = async (\r\n    key: string,\r\n    options = {\r\n      order: 'asc',\r\n      limit: 10,\r\n      offset: 0,\r\n    } as Options\r\n  ): Promise<[User] | undefined> => {\r\n    const sql = `select * from user order by ${key} ${options.order} limit ${options.limit} offset ${options.offset};`\r\n    return new Promise(resolve => {\r\n      this.database.all(sql, [], function(error: any, rows: [any]) {\r\n        if (error || !rows || !rows.length) {\r\n          return resolve(undefined)\r\n        }\r\n        return resolve(rows as [User])\r\n      })\r\n    })\r\n  }\r\n\r\n  public authen = async (\r\n    email: string,\r\n    password: string\r\n  ): Promise<User | undefined> => {\r\n    const self = this\r\n    return new Promise(resolve => {\r\n      this.database.run(\r\n        `update user set uuid = ?, last_access = current_timestamp where email = ? and password = ?;`,\r\n        [uuid(), email, password],\r\n        function(this: any, error: any) {\r\n          if (error || !this.changes) {\r\n            return resolve(undefined)\r\n          }\r\n          self.database.all(\r\n            `select _id, type, uuid, name, email, created_at, updated_at, last_access from user where email = ? and password = ?;`,\r\n            [email, password],\r\n            function(error: any, rows: [any]) {\r\n              if (error || !rows || !rows.length) {\r\n                return resolve(undefined)\r\n              }\r\n              return resolve(rows[0] as User)\r\n            }\r\n          )\r\n        }\r\n      )\r\n    })\r\n  }\r\n\r\n  public expire = async (_id: number): Promise<User | undefined> => {\r\n    const self = this\r\n    return new Promise(resolve => {\r\n      this.database.run(\r\n        `update user set uuid = null, last_access = current_timestamp where _id = ?;`,\r\n        [_id],\r\n        function(this: any, error: any) {\r\n          if (error) {\r\n            return resolve(undefined)\r\n          }\r\n          self.database.all(\r\n            `select * from user where _id = ?;`,\r\n            [_id],\r\n            function(error: any, rows: [any]) {\r\n              if (error || !rows || !rows.length) {\r\n                return resolve(undefined)\r\n              }\r\n              return resolve(rows[0] as User)\r\n            }\r\n          )\r\n        }\r\n      )\r\n    })\r\n  }\r\n\r\n  public refresh = async (_id: number): Promise<User | undefined> => {\r\n    const self = this\r\n    return new Promise(resolve => {\r\n      this.database.run(\r\n        `update user set uuid = ?, last_access = current_timestamp where _id = ?;`,\r\n        [uuid(), _id],\r\n        function(this: any, error: any) {\r\n          if (error) {\r\n            return resolve(undefined)\r\n          }\r\n          self.database.all(\r\n            `select * from user where _id = ?;`,\r\n            [_id],\r\n            function(error: any, rows: [any]) {\r\n              if (error || !rows || !rows.length) {\r\n                return resolve(undefined)\r\n              }\r\n              return resolve(rows[0] as User)\r\n            }\r\n          )\r\n        }\r\n      )\r\n    })\r\n  }\r\n}\r\n\r\nconst userRepo = new UserRepo(database)\r\n\r\nexport default userRepo\r\n"],"file":"user.js"}