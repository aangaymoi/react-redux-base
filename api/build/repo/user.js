"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=exports.UserRepo=void 0;var _debug=_interopRequireDefault(require("debug")),_uuid=_interopRequireDefault(require("uuid")),_database=_interopRequireDefault(require("./database"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}const log=(0,_debug.default)("api:repo:user");class UserRepo{constructor(a){_defineProperty(this,"database",void 0),_defineProperty(this,"create",async a=>new Promise(b=>{const c=this;this.database.run(`insert into user (type, name, email, password) values (?, ?, ?, ?);`,[a.type,a.name,a.email,a.password],function(a){return a?b(void 0):void c.database.all(`select _id, type, name, email, created_at, updated_at, last_access from user where _id = ?;`,[this.lastID],function(a,c){return!a&&c&&c.length?b(c[0]):b(void 0)})})})),_defineProperty(this,"search",async(a,b,c={exact:!0,order:"desc",limit:10,offset:0},d)=>{let e=`select * from user where ${a} `;return c&&(e+=c.exact?`= ? `:`like ? `,d&&(e+=d),c.order&&(e+=`order by ${a} ${c.order} `),void 0!==c.limit&&0<=c.limit&&(e+=`limit ${c.limit} `),void 0!==c.offset&&0<=c.offset&&(e+=`offset ${c.offset} `)),new Promise(a=>{this.database.all(e,[c.exact?b:`%${b}%`],function(b,d){return!b&&d&&d.length?c.exact?a(d[0]):a(d):a(void 0)})})}),_defineProperty(this,"listing",async(a,b={order:"asc",limit:10,offset:0})=>{const c=`select * from user order by ${a} ${b.order} limit ${b.limit} offset ${b.offset};`;return new Promise(a=>{this.database.all(c,[],function(b,c){return!b&&c&&c.length?a(c):a(void 0)})})}),_defineProperty(this,"authen",async(a,b)=>{const c=this;return new Promise(d=>{this.database.run(`update user set uuid = ?, last_access = current_timestamp where email = ? and password = ?;`,[(0,_uuid.default)(),a,b],function(e){return e||!this.changes?d(void 0):void c.database.all(`select _id, type, uuid, name, email, created_at, updated_at, last_access from user where email = ? and password = ?;`,[a,b],function(a,b){return!a&&b&&b.length?d(b[0]):d(void 0)})})})}),_defineProperty(this,"expire",async a=>{const b=this;return new Promise(c=>{this.database.run(`update user set uuid = null, last_access = current_timestamp where _id = ?;`,[a],function(d){return d?c(void 0):void b.database.all(`select * from user where _id = ?;`,[a],function(a,b){return!a&&b&&b.length?c(b[0]):c(void 0)})})})}),_defineProperty(this,"refresh",async a=>{const b=this;return new Promise(c=>{this.database.run(`update user set uuid = ?, last_access = current_timestamp where _id = ?;`,[(0,_uuid.default)(),a],function(d){return d?c(void 0):void b.database.all(`select * from user where _id = ?;`,[a],function(a,b){return!a&&b&&b.length?c(b[0]):c(void 0)})})})}),this.database=a}}exports.UserRepo=UserRepo;const userRepo=new UserRepo(_database.default);var _default=userRepo;exports.default=_default;
//# sourceMappingURL=user.js.map